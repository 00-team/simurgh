upstream simurgh_unix_sock {
    server unix:///usr/share/nginx/sockets/simurgh.sock;
}

log_format heimdall_fmt escape=json '{'
    '"ancient_browser": "$ancient_browser",'
    '"arg_": "$arg_",'
    '"args": "$args",'
    '"binary_remote_addr": "$binary_remote_addr",'
    '"body_bytes_sent": "$body_bytes_sent",'
    '"bytes_sent": "$bytes_sent",'
    '"connection": "$connection",'
    '"connection_requests": "$connection_requests",'
    '"connection_time": "$connection_time",'
    '"connections_active": "$connections_active",'
    '"connections_reading": "$connections_reading",'
    '"connections_waiting": "$connections_waiting",'
    '"connections_writing": "$connections_writing",'
    '"content_length": "$content_length",'
    '"content_type": "$content_type",'
    '"cookie_": "$cookie_",'
    '"date_gmt": "$date_gmt",'
    '"date_local": "$date_local",'
    '"document_root": "$document_root",'
    '"document_uri": "$document_uri",'
    '"fastcgi_path_info": "$fastcgi_path_info",'
    '"fastcgi_script_name": "$fastcgi_script_name",'
    '"geoip_area_code": "$geoip_area_code",'
    '"geoip_city": "$geoip_city",'
    '"geoip_city_continent_code": "$geoip_city_continent_code",'
    '"geoip_city_country_code": "$geoip_city_country_code",'
    '"geoip_city_country_code3": "$geoip_city_country_code3",'
    '"geoip_city_country_name": "$geoip_city_country_name",'
    '"geoip_country_code": "$geoip_country_code",'
    '"geoip_country_code3": "$geoip_country_code3",'
    '"geoip_country_name": "$geoip_country_name",'
    '"geoip_dma_code": "$geoip_dma_code",'
    '"geoip_latitude": "$geoip_latitude",'
    '"geoip_longitude": "$geoip_longitude",'
    '"geoip_org": "$geoip_org",'
    '"geoip_postal_code": "$geoip_postal_code",'
    '"geoip_region": "$geoip_region",'
    '"geoip_region_name": "$geoip_region_name",'
    '"gzip_ratio": "$gzip_ratio",'
    '"host": "$host",'
    '"hostname": "$hostname",'
    '"http2": "$http2",'
    '"http3": "$http3",'
    '"http_": "$http_",'
    '"https": "$https",'
    '"invalid_referer": "$invalid_referer",'
    '"is_args": "$is_args",'
    '"limit_conn_status": "$limit_conn_status",'
    '"limit_rate": "$limit_rate",'
    '"limit_req_status": "$limit_req_status",'
    '"modern_browser": "$modern_browser",'
    '"msec": "$msec",'
    '"msie": "$msie",'
    '"nginx_version": "$nginx_version",'
    '"pid": "$pid",'
    '"pipe": "$pipe",'
    '"proxy_add_x_forwarded_for": "$proxy_add_x_forwarded_for",'
    '"proxy_host": "$proxy_host",'
    '"proxy_port": "$proxy_port",'
    '"proxy_protocol_addr": "$proxy_protocol_addr",'
    '"proxy_protocol_port": "$proxy_protocol_port",'
    '"proxy_protocol_server_addr": "$proxy_protocol_server_addr",'
    '"proxy_protocol_server_port": "$proxy_protocol_server_port",'
    '"proxy_protocol_tlv_": "$proxy_protocol_tlv_",'
    '"proxy_protocol_tlv_aws_vpce_id": "$proxy_protocol_tlv_aws_vpce_id",'
    '"proxy_protocol_tlv_azure_pel_id": "$proxy_protocol_tlv_azure_pel_id",'
    '"proxy_protocol_tlv_gcp_conn_id": "$proxy_protocol_tlv_gcp_conn_id",'
    '"query_string": "$query_string",'
    '"realip_remote_addr": "$realip_remote_addr",'
    '"realip_remote_port": "$realip_remote_port",'
    '"realpath_root": "$realpath_root",'
    '"remote_addr": "$remote_addr",'
    '"remote_port": "$remote_port",'
    '"remote_user": "$remote_user",'
    '"request": "$request",'
    '"request_body": "$request_body",'
    '"request_body_file": "$request_body_file",'
    '"request_completion": "$request_completion",'
    '"request_filename": "$request_filename",'
    '"request_id": "$request_id",'
    '"request_length": "$request_length",'
    '"request_method": "$request_method",'
    '"request_time": "$request_time",'
    '"request_uri": "$request_uri",'
    '"scheme": "$scheme",'
    '"secure_link": "$secure_link",'
    '"secure_link_expires": "$secure_link_expires",'
    '"sent_http_": "$sent_http_",'
    '"sent_trailer_": "$sent_trailer_",'
    '"server_addr": "$server_addr",'
    '"server_name": "$server_name",'
    '"server_port": "$server_port",'
    '"server_protocol": "$server_protocol",'
    '"slice_range": "$slice_range",'
    '"ssl_alpn_protocol": "$ssl_alpn_protocol",'
    '"ssl_cipher": "$ssl_cipher",'
    '"ssl_ciphers": "$ssl_ciphers",'
    '"ssl_protocol": "$ssl_protocol",'
    '"ssl_server_name": "$ssl_server_name",'
    '"ssl_session_id": "$ssl_session_id",'
    '"ssl_session_reused": "$ssl_session_reused",'
    '"status": "$status",'
    '"tcpinfo_rtt": "$tcpinfo_rtt",'
    '"tcpinfo_rttvar": "$tcpinfo_rttvar",'
    '"tcpinfo_snd_cwnd": "$tcpinfo_snd_cwnd",'
    '"tcpinfo_rcv_space": "$tcpinfo_rcv_space",'
    '"uid_got": "$uid_got",'
    '"uid_reset": "$uid_reset",'
    '"uid_set": "$uid_set",'
    '"upstream_addr": "$upstream_addr",'
    '"upstream_bytes_received": "$upstream_bytes_received",'
    '"upstream_bytes_sent": "$upstream_bytes_sent",'
    '"upstream_cache_status": "$upstream_cache_status",'
    '"upstream_connect_time": "$upstream_connect_time",'
    '"upstream_cookie_": "$upstream_cookie_",'
    '"upstream_header_time": "$upstream_header_time",'
    '"upstream_http_": "$upstream_http_",'
    '"upstream_response_length": "$upstream_response_length",'
    '"upstream_response_time": "$upstream_response_time",'
    '"upstream_status": "$upstream_status",'
    '"upstream_trailer_": "$upstream_trailer_",'
    '"uri": "$uri"'
    '}';

server {
    # listen 80;
    listen 443 ssl http2;

    ssl_certificate     /root/.acme.sh/simurgh.00-team.org_ecc/fullchain.cer;
    ssl_certificate_key /root/.acme.sh/simurgh.00-team.org_ecc/simurgh.00-team.org.key;

    server_name simurgh.00-team.org;
    charset utf-8;

    access_log syslog:server=unix:/tmp/heimdall-test.sock,tag=heimdall,nohostname heimdall_fmt;

    # client_max_body_size 1M;

    # error_page 404 /error-404;
    # error_page 403 /error-403;

    location /app-assets {
        alias /x/simurgh/app/dist/app-assets;
    }

    location /simple-assets {
        alias /x/simurgh/simple/dist/simple-assets;
    }

    location /static {
        alias /x/simurgh/static;
    }

    location /record {
        alias /x/simurgh/record;
    }

    location /simurgh-record {
        alias /x/simurgh/record;
    }

    location /simurgh-ssrs {
        alias /x/simurgh/static/ssr;
    }

    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Client-Ip $remote_addr;
        proxy_set_header Host $http_host;
        proxy_redirect off;

        proxy_pass http://simurgh_unix_sock;
    }
}
